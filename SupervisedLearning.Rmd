---
title: "Stat 432 Homework 2 Solution"
date: "Assigned: Aug 29, 2022; <span style='color:red'>Due: 11:59 PM CT, Sep 15, 2022</span>"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '2'
  pdf_document:
    toc: yes
    toc_depth: 2
---

<style>
body {
text-align: justify}
</style>

```{css, echo=FALSE}
.solution {
background-color: #CCDDFF;
}
```

## Instruction

```{r}
library("tidyverse")
spaceship = read.csv("spaceshiptrain_processed.csv")
spaceship = as_tibble(spaceship)
spaceship$Transported = as.factor(spaceship$Transported)


```
```{r}
# split spaceship into train and testing data
# 80% train and 20% test
n = nrow(spaceship)
train_idx = sample(1:n, 0.8 * n)
train = spaceship[train_idx, ]
test = spaceship[-train_idx, ]

```
```{r}
test_accuracy = function(model, type = "raw") {
  preds = as.numeric(predict(model, test, type = type))-1
  actual = test$Transported
  mean(preds == actual)
}

cv = trainControl(method = "cv", number = 5)

```

```{r}
library(caret)
# k nearest neighbors

# variable selection


knn_tune = expand.grid(
  k = seq(2, 40, 2)
)

# model
knn1_cv1 = train(Transported ~ .,
                 data = train,
                 method = "knn", 
                 trControl = cv,
                 tuneGrid = knn_tune
)

# evaluate knn
test_accuracy(knn1_cv1)


```

```{r}
rfe_ctrl <- rfeControl(functions = rfFuncs, # random forest
                      method = "repeatedcv", # repeated cv
                      repeats = 3, # number of repeats
                      number = 5) # number of folds

x_train = train %>% remove_cols(c("Transported")) # the remove_cols function is in dataProcessing.Rmd
y_train = train$Transported
```

```{r}
result_rfe = rfe(x = x_train, 
                  y = y_train, 
                  sizes = c(1:12),
                  rfeControl = rfe_ctrl)
result_rfe
```
```{r}
ggplot(data = result_rfe, metric = "Accuracy") + theme_bw()
ggplot(data = result_rfe, metric = "Kappa") + theme_bw()
```

```{r}
library(ranger)
rf_grid = expand.grid(mtry = c(1, 3, 5), splitrule = c("gini"), min.node.size = c(5, 10, 20))

trcontrol = trainControl(method = "repeatedcv", number = 5, repeats = 3)

models = train(Transported ~ , data = train, method = "ranger", trControl = trcontrol, tuneGrid = rf_grid, num.trees = 300, respect.unordered.factors = "partition")


```

```{r}
library(caret)
# random forest
rf_grid = expand.grid(mtry = c(1, 3), splitrule = c("gini"), min.node.size = c(5, 10, 20))

rf_model = train(form = Transported ~ .,
                data = train,
                method = 'rf',
                trControl = cv,
                tuneGrid = rf_grid,
                verbose = FALSE,
                importance = TRUE)

# evaluate rf2
test_accuracy(rf_model)


```
```{r}
library(varImp)
i_scores <- varImp(rf_model$finalModel, conditional=TRUE)
#Gathering rownames in 'var'  and converting it to the factor
#to provide 'fill' parameter for the bar chart. 
i_scores <- i_scores %>% tibble::rownames_to_column("var") 
i_scores$var<- i_scores$var %>% as.factor()
#Plotting the bar and polar charts for comparing variables
i_bar <- ggplot(data = i_scores) + 
  geom_bar(
    stat = "identity",#it leaves the data without count and bin
    mapping = aes(x = var, y=Overall, fill = var), 
    show.legend = FALSE,
    width = 1
  ) + 
  labs(x = NULL, y = NULL)
i_bar + coord_polar() + theme_minimal()
i_bar + coord_flip() + theme_minimal()

```
  
